generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Archive tables removed - legacy data retention no longer needed
// ArchivedBatch and ArchivedStudent models have been removed

// Attendance models removed - incomplete feature

// Batch (Cohort) - MAHAD ONLY
// Groups Mahad students into cohorts for scheduling and management
// Dugsi program does NOT use batches
model Batch {
  id         String       @id @default(uuid())
  name       String       @unique
  startDate  DateTime?
  endDate    DateTime?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  Enrollment Enrollment[] // Enrollment relation (MAHAD_PROGRAM only)

  @@index([createdAt])
  @@index([endDate])
  @@index([startDate])
}

// ClassSchedule, ClassSession, Subject, Semester removed - incomplete attendance feature
// Each program will have different class and frequency schedules
// Will be redesigned when attendance feature is ready

// Legacy Sibling model removed - use SiblingRelationship instead
// Legacy Student model removed - use Person + ProgramProfile + Enrollment instead

model StudentPayment {
  id               String         @id @default(dbgenerated("gen_random_uuid()"))
  programProfileId String // References ProgramProfile
  year             Int
  month            Int
  amountPaid       Int
  paidAt           DateTime       @db.Timestamp(6)
  stripeInvoiceId  String?
  ProgramProfile   ProgramProfile @relation(fields: [programProfileId], references: [id], onDelete: Cascade)

  @@unique([programProfileId, stripeInvoiceId])
  @@index([programProfileId, year, month])
}

// Teacher - Used for Dugsi program assignments
// Dugsi students are assigned to teachers (not batches)
// Teacher - Staff role linked to Person
// A Person can be a teacher (staff member) while also being a parent, payer, or student
// Teachers can teach in multiple programs (Dugsi, Mahad, etc.) via assignments
// Contact information (email, phone) comes from Person.contactPoints, not stored here
model Teacher {
  id        String   @id @default(uuid())
  personId  String   @unique // One Teacher record per Person
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  person             Person                   @relation(fields: [personId], references: [id], onDelete: Cascade)
  programs           TeacherProgram[] // Programs this teacher is authorized to teach
  assignments        TeacherAssignment[] // Student assignments across all programs
  attendanceSessions DugsiAttendanceSession[]
  checkIns           DugsiTeacherCheckIn[]

  @@index([personId])
}

// TeacherProgram - Links teachers to programs they are authorized to teach
// Explicit program enrollment: Admin assigns which programs (Dugsi, Mahad, etc.) each teacher can teach
// Before assigning students to a teacher, the teacher must have an active TeacherProgram record for that program
model TeacherProgram {
  id        String   @id @default(uuid())
  teacherId String
  program   Program // MAHAD_PROGRAM, DUGSI_PROGRAM, etc.
  shifts    Shift[] // Dugsi: can be [MORNING], [AFTERNOON], or both
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  teacher Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([teacherId, program]) // One record per teacher per program
  @@index([teacherId])
  @@index([program])
  @@index([isActive])
}

// TeacherAssignment - Links teachers to students across all programs
// Supports multi-program assignments: Dugsi (with shifts), Mahad (no shifts), etc.
// Shift is required for Dugsi students (MORNING/AFTERNOON), nullable for other programs
// Teacher must have TeacherProgram enrollment before student assignment
model TeacherAssignment {
  id               String    @id @default(uuid())
  teacherId        String
  programProfileId String // References any ProgramProfile (Dugsi, Mahad, etc.)
  shift            Shift? // Required for Dugsi, null for Mahad and other programs
  startDate        DateTime  @default(now())
  endDate          DateTime? // Null if currently active
  isActive         Boolean   @default(true)
  notes            String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  teacher        Teacher        @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  programProfile ProgramProfile @relation(fields: [programProfileId], references: [id], onDelete: Cascade)

  @@unique([teacherId, programProfileId, shift]) // One teacher per student per shift (shift can be null)
  @@index([teacherId])
  @@index([programProfileId])
  @@index([isActive])
  @@index([shift])
}

enum Shift {
  MORNING
  AFTERNOON
}

enum DugsiAttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

// AttendanceStatus and CheckInMethod enums removed - incomplete feature

// DayOfWeek enum removed - was only used by ClassSchedule (removed)

// EducationLevel enum REMOVED - replaced by GraduationStatus for billing purposes
// Mahad students are now categorized as GRADUATE or NON_GRADUATE for tuition rates

enum GraduationStatus {
  NON_GRADUATE // Still in school (higher base rate: $120/month or $110 bi-monthly)
  GRADUATE // Finished education (lower base rate: $95/month or $90 bi-monthly)
}

enum PaymentFrequency {
  MONTHLY // Charged monthly ($120 or $95)
  BI_MONTHLY // Charged every 2 months ($220 or $180)
}

enum StudentBillingType {
  FULL_TIME // Standard rate
  FULL_TIME_SCHOLARSHIP // Full schedule, $30 off (mutually exclusive with PART_TIME)
  PART_TIME // Half rate - one day/week (mutually exclusive with SCHOLARSHIP)
  EXEMPT // $0 - TA, financial hardship, etc. (no subscription created)
}

enum GradeLevel {
  FRESHMAN
  SOPHOMORE
  JUNIOR
  SENIOR
  KINDERGARTEN
  GRADE_1
  GRADE_2
  GRADE_3
  GRADE_4
  GRADE_5
  GRADE_6
  GRADE_7
  GRADE_8
  GRADE_9
  GRADE_10
  GRADE_11
  GRADE_12
}

enum SubscriptionStatus {
  incomplete
  incomplete_expired
  trialing
  active
  past_due
  canceled
  unpaid
  paused
}

enum Program {
  MAHAD_PROGRAM
  DUGSI_PROGRAM
  YOUTH_EVENTS
  GENERAL_DONATION
}

enum Gender {
  MALE
  FEMALE
}

enum StripeAccountType {
  MAHAD
  DUGSI
  YOUTH_EVENTS
  GENERAL_DONATION
}

enum ContactType {
  EMAIL
  PHONE
  WHATSAPP
  OTHER
}

enum ContactVerificationStatus {
  UNVERIFIED
  VERIFIED
  INVALID
}

enum GuardianRole {
  PARENT
  GUARDIAN
  SPONSOR
  DONOR
}

enum EnrollmentStatus {
  REGISTERED
  ENROLLED
  ON_LEAVE
  WITHDRAWN
  COMPLETED
  SUSPENDED
}

// ============================================================================
// NEW UNIFIED IDENTITY & ENROLLMENT MODELS
// ============================================================================

model Person {
  id          String    @id @default(uuid())
  name        String
  dateOfBirth DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  contactPoints          ContactPoint[]
  guardianRelationships  GuardianRelationship[] @relation("GuardianRelationships")
  dependentRelationships GuardianRelationship[] @relation("DependentRelationships")
  siblingRelationships1  SiblingRelationship[]  @relation("SiblingRelationships1")
  siblingRelationships2  SiblingRelationship[]  @relation("SiblingRelationships2")
  programProfiles        ProgramProfile[]
  billingAccounts        BillingAccount[]
  teacher                Teacher? // Optional: Person can be a teacher (staff role)

  @@index([name])
  @@index([createdAt])
}

model ContactPoint {
  id                 String                    @id @default(uuid())
  personId           String
  type               ContactType // EMAIL, PHONE, WHATSAPP, or OTHER
  value              String // Email address or phone number (normalized)
  isPrimary          Boolean                   @default(false) // Primary contact method for the person
  verificationStatus ContactVerificationStatus @default(UNVERIFIED) // Verification status of contact
  verifiedAt         DateTime? // Timestamp when contact was verified
  isActive           Boolean                   @default(true) // Soft-delete: allows email/phone reuse after deactivation
  deactivatedAt      DateTime? // When contact was deactivated (null if active)
  createdAt          DateTime                  @default(now())
  updatedAt          DateTime                  @updatedAt

  // Relations
  person          Person           @relation(fields: [personId], references: [id], onDelete: Cascade)
  billingAccounts BillingAccount[] // Billing accounts using this contact point

  // Unique constraint includes isActive to allow reuse of deactivated contacts
  // Only active contacts enforce global uniqueness per type+value
  @@unique([type, value, isActive], name: "unique_active_contact_globally")
  @@unique([personId, type, value], name: "unique_contact_per_person") // One contact point per person per type/value combination
  @@index([personId])
  @@index([personId, isPrimary]) // Find primary contact faster
  @@index([value]) // Search by contact value (email/phone)
  @@index([type, value]) // Search by type and value
  @@index([isActive]) // Filter active contacts
}

model GuardianRelationship {
  id             String       @id @default(uuid())
  guardianId     String // Person ID of the guardian (parent, sponsor, etc.)
  dependentId    String // Person ID of the dependent (child/student)
  role           GuardianRole @default(PARENT) // PARENT, GUARDIAN, SPONSOR, or DONOR
  startDate      DateTime     @default(now()) // When relationship started
  endDate        DateTime? // When relationship ended (null if active)
  isActive       Boolean      @default(true) // Currently active relationship
  notes          String? // Optional notes about the relationship
  isPrimaryPayer Boolean      @default(false) // True if this guardian is responsible for tuition payments
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  // IMPORTANT: guardianId !== dependentId (enforced by database CHECK constraint)
  // A person cannot be their own guardian - logical impossibility
  guardian  Person @relation("GuardianRelationships", fields: [guardianId], references: [id], onDelete: Cascade)
  dependent Person @relation("DependentRelationships", fields: [dependentId], references: [id], onDelete: Cascade)

  @@unique([guardianId, dependentId, role]) // One relationship per guardian-dependent-role combo
  @@index([guardianId]) // Find all dependents for a guardian
  @@index([dependentId]) // Find all guardians for a dependent
  @@index([dependentId, isPrimaryPayer]) // Optimize checkout queries for primary payer lookup
  @@index([isActive]) // Filter active relationships
}

model SiblingRelationship {
  id              String    @id @default(uuid())
  person1Id       String
  person2Id       String
  detectionMethod String // 'MANUAL' | 'GUARDIAN_MATCH' | 'NAME_MATCH' | 'CONTACT_MATCH'
  confidence      Float? // 0-1 for automatic detection
  verifiedBy      String? // Admin who verified/created
  verifiedAt      DateTime?
  isActive        Boolean   @default(true)
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  person1 Person @relation("SiblingRelationships1", fields: [person1Id], references: [id], onDelete: Cascade)
  person2 Person @relation("SiblingRelationships2", fields: [person2Id], references: [id], onDelete: Cascade)

  // IMPORTANT: person1Id must be < person2Id (enforced in application code)
  // This ensures (A, B) and (B, A) don't both exist, preventing duplicate relationships
  @@unique([person1Id, person2Id])
  @@index([person1Id])
  @@index([person2Id])
  @@index([isActive])
}

model ProgramProfile {
  id          String           @id @default(uuid())
  personId    String // Foreign key to Person - one person can have multiple profiles (one per program)
  program     Program // MAHAD_PROGRAM, DUGSI_PROGRAM, YOUTH_EVENTS, or GENERAL_DONATION
  status      EnrollmentStatus @default(REGISTERED) // Enrollment status - normalized from legacy string field
  monthlyRate Int              @default(0) // Calculated rate stored here (in cents)

  // Program-specific typed fields (used across programs)
  gender     Gender? // MALE or FEMALE
  gradeLevel GradeLevel? // FRESHMAN through GRADE_12 (Dugsi) or college year (Mahad)
  schoolName String? // Name of current school

  // Mahad billing fields (nullable for non-Mahad profiles)
  // Rate is calculated via calculateMahadRate(graduationStatus, paymentFrequency, billingType)
  graduationStatus GraduationStatus? // NON_GRADUATE or GRADUATE (affects base rate)
  paymentFrequency PaymentFrequency? // MONTHLY or BI_MONTHLY (affects billing interval)
  billingType      StudentBillingType? // FULL_TIME, SCHOLARSHIP, PART_TIME, or EXEMPT
  paymentNotes     String? // Notes like "TA for Sheikh Ahmad" or "Financial hardship approved"

  // Dugsi-specific fields (K-12 program)
  healthInfo        String? // Health information for student
  familyReferenceId String? // Family tracking ID for Dugsi families
  shift             Shift? // Student's preferred shift (MORNING or AFTERNOON)

  // Metadata for initiative-specific fields (JSONB)
  // Flexible JSONB column for program-specific fields without requiring schema migrations
  // See lib/types/program-profile.ts for TypeScript types
  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  person               Person                  @relation(fields: [personId], references: [id], onDelete: Cascade)
  enrollments          Enrollment[]
  assignments          BillingAssignment[]
  payments             StudentPayment[]
  teacherAssignments   TeacherAssignment[]
  dugsiClassEnrollment DugsiClassEnrollment?
  attendanceRecords    DugsiAttendanceRecord[]

  @@unique([personId, program])
  @@index([personId])
  @@index([program])
  @@index([status])
  @@index([program, status])
  @@index([personId, program, status]) // Composite: Find profiles by person, program, status
  @@index([program, status, createdAt]) // Composite: Program-specific lists sorted by date
  @@index([familyReferenceId, program]) // Composite: Find Dugsi family profiles
  @@index([program, shift]) // Composite: Filter Dugsi students by shift
}

model Enrollment {
  id               String           @id @default(uuid())
  programProfileId String
  batchId          String? // MAHAD ONLY - Can be null for Dugsi, donations, or non-batch Mahad enrollments
  // Database CHECK constraint: Dugsi enrollments cannot have batchId (enforced via check_dugsi_no_batch)
  status           EnrollmentStatus @default(REGISTERED)
  startDate        DateTime         @default(now())
  endDate          DateTime? // Null if enrollment is currently active
  reason           String? // Reason for withdrawal, leave, etc.
  notes            String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  // Relations
  programProfile ProgramProfile @relation(fields: [programProfileId], references: [id], onDelete: Cascade)
  batch          Batch?         @relation(fields: [batchId], references: [id]) // MAHAD ONLY

  @@index([programProfileId])
  @@index([batchId])
  @@index([status])
  @@index([startDate])
  @@index([endDate]) // Index for filtering active enrollments (endDate IS NULL)
  @@index([programProfileId, status])
  @@index([programProfileId, status, endDate]) // Composite: Find active enrollments
  @@index([batchId, status, startDate]) // Composite: Batch enrollments by status and start date
}

model BillingAccount {
  id          String            @id @default(uuid())
  personId    String? // Null for organization/entity accounts (not linked to a Person)
  accountType StripeAccountType // MAHAD, DUGSI, YOUTH_EVENTS, or GENERAL_DONATION

  // Stripe customer IDs per account type
  // Separate customer IDs allow different billing setups per program
  stripeCustomerIdMahad    String? // Stripe customer ID for Mahad program
  stripeCustomerIdDugsi    String? // Stripe customer ID for Dugsi program
  stripeCustomerIdYouth    String? // Stripe customer ID for Youth Events
  stripeCustomerIdDonation String? // Stripe customer ID for General Donations

  // ACH/Bank account info (for Dugsi)
  // Dugsi supports ACH/bank account payments in addition to card payments
  paymentIntentIdDugsi    String? // Payment intent ID for Dugsi ACH payments
  paymentMethodCaptured   Boolean   @default(false) // Whether payment method has been captured
  paymentMethodCapturedAt DateTime? // Timestamp when payment method was captured

  // Primary contact preference
  primaryContactPointId String? // Preferred contact point for billing communications

  notes     String? // Optional notes about the billing account
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  person              Person?        @relation(fields: [personId], references: [id], onDelete: SetNull) // SetNull allows organization accounts
  primaryContactPoint ContactPoint?  @relation(fields: [primaryContactPointId], references: [id], onDelete: SetNull)
  subscriptions       Subscription[] // All subscriptions for this billing account

  @@index([personId]) // Find accounts for a person
  @@index([accountType]) // Filter by account type
  @@index([stripeCustomerIdMahad]) // Find by Mahad Stripe customer ID
  @@index([stripeCustomerIdDugsi]) // Find by Dugsi Stripe customer ID
}

model Subscription {
  id                   String             @id @default(uuid())
  billingAccountId     String
  stripeAccountType    StripeAccountType
  stripeSubscriptionId String             @unique
  stripeCustomerId     String
  status               SubscriptionStatus @default(incomplete)
  amount               Int // Amount in cents
  currency             String             @default("usd")
  interval             String             @default("month") // month, year, etc.

  // Period tracking
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  paidUntil          DateTime?
  lastPaymentDate    DateTime?

  // History tracking
  previousSubscriptionIds String[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  billingAccount BillingAccount        @relation(fields: [billingAccountId], references: [id], onDelete: Cascade)
  assignments    BillingAssignment[]
  history        SubscriptionHistory[]

  @@index([billingAccountId])
  @@index([stripeSubscriptionId])
  @@index([stripeCustomerId])
  @@index([status])
  @@index([stripeAccountType, status])
}

model BillingAssignment {
  id               String    @id @default(uuid())
  subscriptionId   String // Foreign key to Subscription
  programProfileId String // Foreign key to ProgramProfile
  amount           Int // Amount allocated to this profile (in cents)
  percentage       Float? // Percentage of subscription allocated (if applicable, for split payments)
  isActive         Boolean   @default(true) // Currently active assignment
  startDate        DateTime  @default(now()) // When assignment started
  endDate          DateTime? // When assignment ended (null if active)
  notes            String? // Optional notes about the assignment
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  // Supports split payments: one subscription can be allocated to multiple profiles
  subscription   Subscription   @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  programProfile ProgramProfile @relation(fields: [programProfileId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([programProfileId])
  @@index([isActive])
  @@index([subscriptionId, programProfileId])
  @@index([subscriptionId, isActive]) // Composite: Active assignments per subscription
  @@index([programProfileId, isActive]) // Composite: Active assignments per profile
  @@index([subscriptionId, isActive, amount]) // Composite: Calculate totals faster for validation
}

model SubscriptionHistory {
  id             String             @id @default(uuid())
  subscriptionId String
  eventType      String // Stripe event type (e.g., "invoice.payment_succeeded")
  eventId        String // Stripe event ID
  status         SubscriptionStatus
  amount         Int?
  metadata       Json? // Additional event data
  processedAt    DateTime           @default(now())

  // Relations
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([eventType])
  @@index([processedAt])
}

model WebhookEvent {
  id          String   @id @default(uuid())
  eventId     String
  eventType   String
  source      String // 'mahad' or 'dugsi'
  processedAt DateTime @default(now())
  payload     Json?

  @@unique([eventId, source])
  @@index([processedAt])
  @@index([eventType])
}

model DugsiClass {
  id          String   @id @default(uuid())
  name        String   @unique
  shift       Shift
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  students DugsiClassEnrollment[]
  sessions DugsiAttendanceSession[]

  @@index([shift])
  @@index([isActive])
}

model DugsiClassEnrollment {
  id               String    @id @default(uuid())
  classId          String
  programProfileId String    @unique
  startDate        DateTime  @default(now())
  endDate          DateTime?
  isActive         Boolean   @default(true)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  class          DugsiClass     @relation(fields: [classId], references: [id], onDelete: Cascade)
  programProfile ProgramProfile @relation(fields: [programProfileId], references: [id], onDelete: Cascade)

  @@index([classId])
  @@index([isActive])
  @@index([classId, isActive])
}

model DugsiAttendanceSession {
  id        String   @id @default(uuid())
  date      DateTime @db.Date
  classId   String
  teacherId String
  notes     String?
  isClosed  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  class   DugsiClass              @relation(fields: [classId], references: [id], onDelete: Cascade)
  teacher Teacher                 @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  records DugsiAttendanceRecord[]

  @@unique([date, classId])
  @@index([date])
  @@index([classId])
  @@index([teacherId, date])
}

model DugsiAttendanceRecord {
  id               String                @id @default(uuid())
  sessionId        String
  programProfileId String
  status           DugsiAttendanceStatus
  lessonCompleted  Boolean               @default(false)
  surahName        String?
  ayatFrom         Int?
  ayatTo           Int?
  lessonNotes      String?
  notes            String?
  markedAt         DateTime              @default(now())
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt

  session DugsiAttendanceSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  profile ProgramProfile         @relation(fields: [programProfileId], references: [id], onDelete: Cascade)

  @@unique([sessionId, programProfileId])
  @@index([sessionId])
  @@index([programProfileId])
  @@index([status])
  @@index([programProfileId, status])
}

model DugsiTeacherCheckIn {
  id           String    @id @default(uuid())
  teacherId    String
  date         DateTime  @db.Date
  shift        Shift
  clockInTime  DateTime
  clockInLat   Float?
  clockInLng   Float?
  clockInValid Boolean
  clockOutTime DateTime?
  clockOutLat  Float?
  clockOutLng  Float?
  isLate       Boolean   @default(false)
  notes        String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  teacher Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([teacherId, date, shift])
  @@index([teacherId])
  @@index([date])
  @@index([shift])
}
